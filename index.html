<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Image Upload & Download</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 text-gray-800">

  <div class="max-w-xl mx-auto mt-10 p-6 bg-white rounded-xl shadow">
    <h1 class="text-2xl font-bold text-center text-blue-600 mb-4">üì§ Upload & Download Images</h1>

    <input
      type="file"
      id="fileInput"
      multiple
      accept="image/*"
      class="block w-full mb-4 text-sm text-gray-500 file:mr-4 file:py-2 file:px-4
             file:rounded-full file:border-0
             file:text-sm file:font-semibold
             file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"
    />

    <button
      onclick="uploadFiles()"
      id="uploadBtn"
      class="w-full py-2 px-4 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50"
    >
      Upload Selected
    </button>

    <h2 class="text-lg font-semibold mt-6">Uploaded Images:</h2>
    <ul id="fileList" class="mt-3 space-y-3"></ul>
  </div>

  <script>
    const backendURL = 'https://uploadphotos-44c5.onrender.com';
    const fileInput = document.getElementById('fileInput');
    const fileList = document.getElementById('fileList');
    const uploadBtn = document.getElementById('uploadBtn');

    async function uploadFiles() {
      const files = fileInput.files;
      if (!files.length) {
        alert("Please select at least one image");
        return;
      }

      uploadBtn.disabled = true;

      for (const file of files) {
        const formData = new FormData();
        formData.append('image', file);

        try {
          const res = await fetch(`${backendURL}/upload`, {
            method: 'POST',
            body: formData,
          });

          const data = await res.json();
          if (data.filename) {
            const li = document.createElement('li');
            li.className = "flex items-center justify-between bg-gray-100 px-4 py-2 rounded-md border";
            li.innerHTML = `
              <span class="truncate max-w-[60%]">${data.filename}</span>
              <button
                class="bg-green-500 text-white px-3 py-1 rounded hover:bg-green-600"
                onclick="downloadFile('${data.filename}', this)"
              >
                Download
              </button>
            `;
            fileList.appendChild(li);
          }
        } catch (err) {
          alert("Upload failed for: " + file.name);
          console.error(err);
        }
      }

      fileInput.value = '';
      uploadBtn.disabled = false;
    }

    async function downloadFile(filename, button) {
      try {
        const res = await fetch(`${backendURL}/download/${filename}`);
        if (!res.ok) throw new Error("Download failed");

        const blob = await res.blob();
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);

        // Mark as deleted
        button.disabled = true;
        button.textContent = 'üóëÔ∏è Deleted';
        button.classList.remove('bg-green-500', 'hover:bg-green-600');
        button.classList.add('bg-red-500');
      } catch (err) {
        alert("‚ùå Already downloaded or error occurred.");
        console.error(err);
        button.disabled = true;
        button.textContent = 'üóëÔ∏è Deleted';
      }
    }
  </script>

</body>
</html>
